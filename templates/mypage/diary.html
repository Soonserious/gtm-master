{% extends "common/base.html" %}

{% block css %}
<style>
    .td-contenteditable {
        height: 50px;
    }

    .div-contenteditable {
        height: 100%;
    }

    .div-contenteditable:after {
        content:'\0200B';
    }
    .table_data_remove_border_line{
            width:100%;
            border-style :none;

    }
    .top-padd{
        padding-top:7px;
    }
</style>
{% endblock %}

{% block content %}
<div class="panel panel-default">
    <div class="panel-heading">
        <h5 class="panel-title text-center">골프일지</h5>
    </div>
    <div class="panel-body">
        <div class="row">
            <div class="col-xs-2 text-center top-padd">
                <strong>날짜</strong>
            </div>
            <div class="col-xs-4">
                <div class="form-group">
                    <input type='text' required="true" name='date' class="form-control" id='id-date'/>
                </div>
            </div>
            <!--<div class="col-xs-4 text-center">-->
                <!--&lt;!&ndash;<strong>유형</strong>&ndash;&gt;-->
            <!--</div>-->
            <div class="col-xs-12" style="display:none">
                <div class="form-group">
                    <select class="form-control" id="id-competition_level">
                        <option value="0">연습</option>
                        <option value="1" selected>연습경기</option>
                        <option value="2">대회</option>
                    </select>
                </div>
            </div>
            <div class="col-xs-2 text-center top-padd">
                <strong>대회명</strong>
            </div>
            <div class="col-xs-4">
                <div class="form-group">
                    <input type="text" class="form-control" id="id-competition_name" name="competition_name">
                </div>
            </div>
        </div>
        <table class="table table-bordered" style="table-layout:fixed; word-break:break-all;">
            <tr>
                <th style="vertical-align:middle">1. 오늘 무엇을 배웠나?</th>
            </tr>
            <tr>
                <td style="vertical-align:middle" class="td-contenteditable" name="content_0">
                     <textarea required="required" class="table_data_remove_border_line" name="content_0">{{ content_0 }}</textarea>
                </td>
            </tr>
            <tr>
                <th style="vertical-align:middle">2. 오늘 라운드는 어땠나?</th>
            </tr>
            <tr>
                <td style="vertical-align:middle" class="td-contenteditable" name="content_1">
                    <textarea required="required" class="table_data_remove_border_line" name="content_1">{{ content_1 }}</textarea>
                </td>
            </tr>
            <tr>
                <th style="vertical-align:middle">3. 오늘 라운드에서 어떤 경험을 기억하고 싶은가?</th>
            </tr>
            <tr>
                <td style="vertical-align:middle" class="td-contenteditable" name="content_2">
                     <textarea required="required" class="table_data_remove_border_line" name="content_2">{{ content_2 }}</textarea>
                </td>
            </tr>
            <tr>
                <th style="vertical-align:middle">4. 자신의 스코어에 연연하는 대신 (게임) 과정에 흡수되는 시기가 있었는가?</th>
            </tr>
            <tr>
                <td style="vertical-align:middle" class="td-contenteditable" name="content_3">
                     <textarea required="required" class="table_data_remove_border_line" name="content_3">{{ content_3 }}</textarea>
                </td>
            </tr>
            <tr>
                <th style="vertical-align:middle">5. 그 시기에는 당신에게 어떤 차이가 있었는가?</th>
            </tr>
            <tr>
                <td style="vertical-align:middle" class="td-contenteditable" name="content_4">
                     <textarea required="required" class="table_data_remove_border_line" name="content_4">{{ content_4 }}</textarea>
                </td>
            </tr>
            <tr>
                <th style="vertical-align:middle">6. 오늘 코스에서 있었던 당신의 최고의 경험에 대해 말하라.</th>
            </tr>
            <tr>
                <td style="vertical-align:middle" class="td-contenteditable" name="content_5">
                     <textarea required="required" class="table_data_remove_border_line" name="content_5">{{ content_5 }}</textarea>
                </td>
            </tr>
            <tr>
                <th style="vertical-align:middle">7. 오늘 당신이 한 중요한 결정들 중에 하나는 무엇인가?</th>
            </tr>
            <tr>
                <td style="vertical-align:middle" class="td-contenteditable" name="content_6">
                     <textarea required="required" class="table_data_remove_border_line" name="content_6">{{ content_6 }}</textarea>
                </td>
            </tr>
            <tr>
                <th style="vertical-align:middle">8. 오늘 코스에 있을 때 어디에 그리고 무엇에 초점을 두었는가(집중)?</th>
            </tr>
            <tr>
                <td style="vertical-align:middle" class="td-contenteditable" name="content_7">
                     <textarea required="required" class="table_data_remove_border_line" name="content_7">{{ content_7 }}</textarea>
                </td>
            </tr>
            <tr>
                <th style="vertical-align:middle">9. 오늘 라운드에서 한 가지를 다르게 할 수 있었다면, 그것은 무엇인가?</th>
            </tr>
            <tr>
                <td style="vertical-align:middle" class="td-contenteditable" name="content_8">
                     <textarea required="required" class="table_data_remove_border_line" name="content_8">{{ content_8 }}</textarea>
                </td>
            </tr>
            <tr>
                <th style="vertical-align:middle">10. (오늘) 배운 것을 토대로 다음 토너먼트나 라운드를 어떻게 준비하고 싶은가?</th>
            </tr>
            <tr>
                <td style="vertical-align:middle" class="td-contenteditable" name="content_9">
                     <textarea required="required" class="table_data_remove_border_line" name="content_9">{{ content_9 }}</textarea>
                </td>
            </tr>
        </table>

        <div class="row">
            <div class="col-xs-10" align="right" id="submit_status"></div>
            <div class="col-xs-2" align="right">
                <button type="button" class="btn btn-primary" value=0>저장하기</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}




<script type='text/javascript'>

 $(function () {
            $('input[name="date"]').datetimepicker({
                format: 'YYYY-MM-DD',
                showTodayButton: true,
                showClose: true
            });
        });

(function () {
    if ({{ record_exists }}) {
        $("#id-date").val("{{ date }}");
        $("#id-competition_level").val("{{ competition_level }}");
        $("#id-competition_name").val("{{ competition_name }}");
    }
})();

$("#id-date").on("dp.change",function(dateText){
        $(this).val(dateText.date.format('YYYY-MM-DD'));
        console.log($(this).val());
        $.ajax({
        url: "/mypage/diary_exsist",
        type: "GET",
        data: {"date" : $("#id-date").val(),
                "competition_level" : $("#id-competition_level").val()},
        dataType: "json",
        success: function(data) {
            if(data.dumped_contents){
                console.log(data.dumped_contents)

                for(i=0; i<Object.keys(data.dumped_contents).length;i++){
                    var target = "content_" + i;
                    $("textarea[name="+target+"]").val(data.dumped_contents[target]);
                    console.log(data.dumped_contents[target]);
                }
                $("#id-competition_name").val(data.competition_name);
            }else{
                $("textarea").each(function(){
                    $(this).val(" ");
                    $("#id-competition_name").val(" ");
                })
            }
        }
    })

});
<!--$("#id-date").datepicker({onSelect:function(dateText){-->
    <!--$(this).val(dateText);-->
    <!--console.log($(this).val());-->
    <!--$.ajax({-->
        <!--url: "/mypage/diary_exsist",-->
        <!--type: "GET",-->
        <!--data: {"date" : $("#id-date").val(),-->
                <!--"competition_level" : $("#id-competition_level").val()},-->
        <!--dataType: "json",-->
        <!--success: function(data) {-->
            <!--if(data.dumped_contents){-->
                <!--for(i=0; i<Object.keys(data.dumped_contents).length;i++){-->
                    <!--var target = "content_" + i;-->
                    <!--$("textarea[name="+target+"]").val(data.dumped_contents[target]);-->
                    <!--console.log(data.dumped_contents[target]);-->
                <!--}-->
            <!--}else{-->
                <!--$("textarea").each(function(){-->
                    <!--$(this).val(" ");-->
                <!--})-->
            <!--}-->
        <!--}-->
    <!--})-->
<!--})-->
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
$(function() { $.ajaxSetup({headers: {"X-CSRFToken": getCookie("csrftoken")}}); });

$('div[contenteditable="true"]').keypress(function(event) {
    if (event.which != 13)
        return true;

    var docFragment = document.createDocumentFragment();
    var newEle = document.createElement('br');
    docFragment.appendChild(newEle);

    //make the br replace selection
    var range = window.getSelection().getRangeAt(0);
    range.deleteContents();
    range.insertNode(docFragment);

    //create a new range
    range = document.createRange();
    range.setStartAfter(newEle);
    range.collapse(true);

    //make the cursor there
    var sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);

    return false;
});

$("#id-competition_level").on("input",function(){
    console.log("competition input")
    $.ajax({
        url: "/mypage/diary_exsist",
        type: "GET",
        data: {"date" : $("#id-date").val(),
                "competition_level" : $("#id-competition_level").val()},
        dataType: "json",
        success: function(data) {
            if(data.dumped_contents){
                for(i=0; i<Object.keys(data.dumped_contents).length;i++){
                    var target = "content_" + i;
                    $("textarea[name="+target+"]").val(data.dumped_contents[target]);
                    console.log(data.dumped_contents[target]);
                }
            }else{
                $("textarea").each(function(){
                    $(this).val(" ");
                })
            }
        }
    })
})

$(".btn").on("click", function() {
    console.log("shit");
    var date = $("#id-date").val();
    if (date == "") {
        $("#id-date").focus();
        $('html,body').animate({scrollTop: $("#id-date").offset().top - 20});
        return;
    }
    var contents = $("textarea[name^=content]");
    var contents_dict={};
    for (var i = 0; i < contents.length; ++i) {
       contents_dict[contents[i].getAttribute("name")] = $(contents[i]).val();
    }
    contents_dict["date"] = $("#id-date").val();
    var competition_level = $("#id-competition_level").val();
    contents_dict["competition_level"] = competition_level;
    contents_dict["competition_name"] = $("#id-competition_name").val();

    console.log(contents_dict);
    $.ajax({
        url: "{% url 'mp_diary' %}",
        type: "POST",
        data: contents_dict,
        dataType: "json",
        success: function(data) {
            $("#submit_status").html(data['status']);
        }
    });
});
</script>
{% endblock %}