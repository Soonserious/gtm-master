{% extends "common/base.html" %}

{% block css %}
{% endblock %}

{% block content %}
<div class="page-header">
    <h3>G4 Profile</h3>
</div>

<div class="panel panel-default">
    <div class="panel-heading"><h4><b>Student Information</b></h4></div>
    <table class="table table-bordered">
        <thead class="thead">
        <tr>
            <th><div align="center">이름</div></th>
            <th><div align="center">성별</div></th>
            <th><div align="center">생년월일</div></th>
            <th><div align="center">핸디캡</div></th>
            <th><div align="center">소속</div></th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td><div align="center">{{ member_info.name }}</div></td>
            <td><div align="center">{{ member_info.sex }}</div></td>
            <td><div align="center">{{ member_info.birth }}</div></td>
            <td><div align="center">{{ member_info.handicap|floatformat:2 }}</div></td>
            <td><div align="center">{{ member_info.association }}</div></td>
        </tr>
    </table>
</div>
<div class="panel panel-default">
    <div class="panel-heading"><h4><b>1. OCEAN Test</b></h4></div>
    <div class="panel-heading" id="p0_date"></div>
    <table class="table table-bordered">
        <thead class="thead">
        <tr>
            <th><div align="center">Traits</div></th>
            <th><div align="center">Baseline T-Score</div></th>
            <th><div align="center">Current Score</div></th>
            <th><div align="center">Current T-Score</div></th>
        </tr>
        </thead>
        <tbody>
        {% for factor in factors_1 %}
        <tr>
            <td><div align="center">{{ factor }}</div></td>
            <td><div id="p0_baseline_t_score_{{ forloop.counter0 }}" align="center"></div></td>
            <td><div id="p0_current_score_{{ forloop.counter0 }}" align="center"></div></td>
            <td><div id="p0_current_t_score_{{ forloop.counter0 }}" align="center"></div></td>
        </tr>
        {% endfor %}
        <tr>
            <td colspan="4"><canvas id="p0_chart" height="240"></canvas></td>
        </tr>
    </table>
</div>
<div class="contrainer">
    <div class="row">
        <div class="col-sm-1" align="center">코멘트</div>
        <div class="col-sm-11">
            {% if is_admin %}
            <textarea id="p0_comment" class="form-control" rows="5"></textarea>
            {% else %}
            <div class="well well-sm" id="p0_comment" align="justify"></div>
            {% endif %}
        </div>
    </div>
    <br>

    {% if is_admin %}
    <br>
    <div class="row">
        <div class="col-sm-12" align="right">
            <button type="button" class="btn btn-primary" value=0>저장하기</button>
        </div>
    </div>
    {% endif %}
</div>
<hr>
<div class="panel panel-default">
    <div class="panel-heading"><h4><b>2. IZOF based GMET</b></h4></div>
    <div class="panel-heading" id="p1_date"></div>
    <table class="table table-bordered">
        <thead class="thead">
        <tr>
            <th><div align="center">GMET 요인</div></th>
            <th><div align="center">Baseline T-Score</div></th>
            <th><div align="center">Current Score</div></th>
            <th><div align="center">Current T-Score</div></th>
        </tr>
        </thead>
        <tbody>
        {% for factor in factors_2 %}
        <tr>
            <td><div align="center">{{ factor }}</div></td>
            <td><div id="p1_baseline_t_score_{{ forloop.counter0 }}" align="center"></div></td>
            <td><div id="p1_current_score_{{ forloop.counter0 }}" align="center"></div></td>
            <td><div id="p1_current_t_score_{{ forloop.counter0 }}" align="center"></div></td>
        </tr>
        {% endfor %}
        <tr>
            <td colspan="5"><canvas id="p1_chart" height="240"></canvas></td>
        </tr>
    </table>
</div>
<div class="contrainer">
    <div class="row">
        <div class="col-sm-1" align="center">코멘트</div>
        <div class="col-sm-11">
            {% if is_admin %}
            <textarea id="p1_comment" class="form-control" rows="5"></textarea>
            {% else %}
            <div class="well well-sm" id="p1_comment" align="justify"></div>
            {% endif %}
        </div>
    </div>
    <br>

    {% if is_admin %}
    <br>
    <div class="row">
        <div class="col-sm-12" align="right">
            <button type="button" class="btn btn-primary" value=1>저장하기</button>
        </div>
    </div>
    {% endif %}
</div>
<hr>
<div class="panel panel-default">
    <div class="panel-heading"><h4><b>3. IZOF based TOPS</b></h4></div>
    <div class="panel-heading" id="p2_date"></div>
    <table class="table table-bordered">
        <thead class="thead">
        <tr>
            <th><div align="center">Factor</div></th>
            <th><div align="center">Baseline Level</div></th>
            <th><div align="center">Current Level</div></th>
        </tr>
        </thead>
        <tbody>
        {% for factor in factors_3 %}
        <tr>
            <td><div align="center">{{ factor }}</div></td>
            <td><div id="p2_baseline_level_{{ forloop.counter0 }}" align="center"></div></td>
            <td><div id="p2_current_level_{{ forloop.counter0 }}" align="center"></div></td>
        </tr>
        {% endfor %}
        <tr>
            <td colspan="4"><canvas id="p2_chart" height="240"></canvas></td>
        </tr>
    </table>
</div>
<div class="contrainer">
    <div class="row">
        <div class="col-sm-1" align="center">코멘트</div>
        <div class="col-sm-11">
            {% if is_admin %}
            <textarea id="p2_comment" class="form-control" rows="5"></textarea>
            {% else %}
            <div class="well well-sm" id="p2_comment" align="justify"></div>
            {% endif %}
        </div>
    </div>
    <br>

    {% if is_admin %}
    <br>
    <div class="row">
        <div class="col-sm-12" align="right">
            <button type="button" class="btn btn-primary" value=2>저장하기</button>
        </div>
    </div>
    {% endif %}
</div>
<hr>
<div class="panel panel-default">
    <div class="panel-heading"><h4><b>4. IZOF based FSS</b></h4></div>
    <div class="panel-heading" id="p3_date"></div>
    <table class="table table-bordered">
        <thead class="thead">
        <tr>
            <th colspan="2"><div align="center">Factor</div></th>
            <th><div align="center">Baseline Level</div></th>
            <th><div align="center">Current Level</div></th>
        </tr>
        </thead>
        <tbody>
        {% for factor in factors_4 %}
        <tr>
            <td colspan="2"><div align="center">{{ factor }}</div></td>
            <td><div id="p3_baseline_level_{{ forloop.counter0 }}" align="center"></div></td>
            <td><div id="p3_current_level_{{ forloop.counter0 }}" align="center"></div></td>
        </tr>
        {% endfor %}
        <tr>
            <td colspan="4"><canvas id="p3_chart" height="240"></canvas></td>
        </tr>
    </table>
</div>
<div class="contrainer">
    <div class="row">
        <div class="col-sm-1" align="center">코멘트</div>
        <div class="col-sm-11">
            {% if is_admin %}
            <textarea id="p3_comment" class="form-control" rows="5"></textarea>
            {% else %}
            <div class="well well-sm" id="p3_comment" align="justify"></div>
            {% endif %}
        </div>
    </div>
    <br>

    {% if is_admin %}
    <br>
    <div class="row">
        <div class="col-sm-12" align="right">
            <button type="button" class="btn btn-primary" value="3">저장하기</button>
        </div>
    </div>
    {% endif %}
</div>
<hr>
<div class="panel panel-default">
    <div class="panel-heading"><h4><b>5. IZOF based ACSI-28</b></h4></div>
    <div class="panel-heading" id="p4_date"></div>
    <table class="table table-bordered">
        <thead class="thead">
        <tr>
            <th colspan="2"><div align="center">Factor</div></th>
            <th><div align="center">Baseline Level</div></th>
            <th><div align="center">Current Level</div></th>
        </tr>
        </thead>
        <tbody>
        {% for factor in factors_5 %}
        <tr>
            <td colspan="2"><div align="center">{{ factor }}</div></td>
            <td><div id="p4_baseline_level_{{ forloop.counter0 }}" align="center"></div></td>
            <td><div id="p4_current_level_{{ forloop.counter0 }}" align="center"></div></td>
        </tr>
        {% endfor %}
        <tr>
            <td colspan="4"><canvas id="p4_chart" height="240"></canvas></td>
        </tr>
    </table>
</div>
<div class="contrainer">
    <div class="row">
        <div class="col-sm-1" align="center">코멘트</div>
        <div class="col-sm-11">
            {% if is_admin %}
            <textarea id="p4_comment" class="form-control" rows="5"></textarea>
            {% else %}
            <div class="well well-sm" id="p4_comment" align="justify"></div>
            {% endif %}
        </div>
    </div>
    <br>
    <div class="row">
        <div class="col-sm-3" align="center">인지-행동 수행전략</div>
        <div class="col-sm-8">
            {% if is_admin %}
            <textarea id="p4_strategy" class="form-control" rows="5"></textarea>
            {% else %}
            <div class="well well-sm" id="p4_strategy" align="justify"></div>
            {% endif %}
        </div>
    </div>
    {% if is_admin %}
    <br>
    <div class="row">
        <div class="col-sm-12" align="right">
            <button type="button" class="btn btn-primary" value="4">저장하기</button>
        </div>
    </div>
    {% endif %}
</div>
<hr>
<div class="panel panel-default">
    <div class="panel-heading"><h4><b>6. IZOF based Course Management</b></h4></div>
    <div class="panel-heading" id="p5_date"></div>
    <table class="table table-bordered">
        <thead class="thead">
        <tr>
            <th colspan="2"><div align="center">Content</div></th>
            <th><div align="center">Baseline Level</div></th>
            <th><div align="center">Current Level</div></th>
        </tr>
        </thead>
        <tbody>
        {% for factor in factors_6 %}
        <tr>
            <td colspan="2"><div align="center">{{ factor }}</div></td>
            <td><div id="p5_baseline_level_{{ forloop.counter0 }}" align="center"></div></td>
            <td><div id="p5_current_level_{{ forloop.counter0 }}" align="center"></div></td>
        </tr>
        {% endfor %}
        <tr>
            <td colspan="4"><canvas id="p5_chart" height="240"></canvas></td>
        </tr>
    </table>
</div>
<div class="contrainer">
    <div class="row">
        <div class="col-sm-1" align="center">코멘트</div>
        <div class="col-sm-11">
            {% if is_admin %}
            <textarea id="p5_comment" class="form-control" rows="5"></textarea>
            {% else %}
            <div class="well well-sm" id="p5_comment" align="justify"></div>
            {% endif %}
        </div>
    </div>
    <br>
    <div class="row">
        <div class="col-sm-1" align="center">전략</div>
        <div class="col-sm-11">
            {% if is_admin %}
            <textarea id="p5_strategy" class="form-control" rows="5"></textarea>
            {% else %}
            <div class="well well-sm" id="p5_strategy" align="justify"></div>
            {% endif %}
        </div>
    </div>
    {% if is_admin %}
    <br>
    <div class="row">
        <div class="col-sm-12" align="right">
            <button type="button" class="btn btn-primary" value="5">저장하기</button>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block js %}
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.min.js"></script>
<script type="text/javascript">
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
$(function() { $.ajaxSetup({headers: {"X-CSRFToken": getCookie("csrftoken")}}); });

Chart.defaults.global.responsive = true;
Chart.defaults.global.maintainAspectRatio = false;

function drawBarChart(ctx, axisLabels, b_label, c_label, b_values, c_values, min, max, stepSize) {
    var b_backgroundColor = [];
    var b_borderColor = [];
    var c_backgroundColor = [];
    var c_borderColor = [];
    axisLabels_linefeeded = []
    for (var i = 0; i < axisLabels.length; ++i) {
        b_backgroundColor.push('rgba(255, 99, 132, 0.2)');
        b_borderColor.push('rgba(255,99,132,1)');
        c_backgroundColor.push('rgba(54, 162, 235, 0.2)');
        c_borderColor.push('rgba(54, 162, 235, 1)');
        var s = axisLabels[i];
        if (s.indexOf("(") != -1) {
            axisLabels_linefeeded.push(s.substring(s.indexOf("(") + 1, s.indexOf(")")));
        }
        else {
            axisLabels_linefeeded.push(s);
        }
    }
    var options = {}
    if (!(min === null)) {
        var options = {
            scales: {
                yAxes: [{
                    ticks: {
                        min: min,
                        max: max,
                        stepSize: stepSize
                    }
                }]
            }
        }
    }
    var barChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: axisLabels_linefeeded,
            datasets: [
                {
                    data: b_values,
                    label: b_label,
                    backgroundColor: b_backgroundColor,
                    borderColor: b_borderColor,
                    borderWidth: 1
                },
                {
                    data: c_values,
                    label: c_label,
                    backgroundColor: c_backgroundColor,
                    borderColor: c_borderColor,
                    borderWidth: 1
                }
            ]
        },
        options: options
    });
}

function drawRadarChart(ctx, axisLabels, b_label, c_label, b_values, c_values) {
    var radarChart = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: axisLabels,
            datasets: [
                {
                    data: b_values,
                    label: b_label,
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgba(255,99,132,1)'
                },
                {
                    data: c_values,
                    label: c_label,
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)'
                }
            ]
        },
        options: {
            scale: {
                ticks: {
                    min: 0,
                    max: 5,
                    stepSize: 1
                },
                pointLabels: {
                    fontSize: 12
                }
            }
        }
    });
}

$(function() {
    $.ajax({
        url: "{% url 'g4_profile' %}",
        type: "POST",
        data: {"target_user_id": "{{ target_user_id }}"},
        dataType: "json",
        success: function(data) {
            for (var i = 0; i < data.titles.length; ++i) {
                if (data.b_eval[i] === "") {
                    $("#p" + i + "_chart").hide();
                    continue;
                }
                if ($("#p" + i + "_date").length) {
                    $("#p" + i + "_date").html(data.c_eval[i]["date"]);
                }
                for (var j = 0; j < data.num_attributes[i]; ++j) {
                    if ($("#p" + i + "_baseline_t_score_" + j).length) {
                        $("#p" + i + "_baseline_t_score_" + j).html(data.b_eval[i]["t-scores"][j]);
                    }
                    if ($("#p" + i + "_baseline_level_" + j).length) {
                        $("#p" + i + "_baseline_level_" + j).html(data.b_eval[i]["levels"][j]);
                    }
                    if ($("#p" + i + "_current_score_" + j).length) {
                        $("#p" + i + "_current_score_" + j).html(data.c_eval[i]["scores"][j]);
                    }
                    if ($("#p" + i + "_current_t_score_" + j).length) {
                        $("#p" + i + "_current_t_score_" + j).html(data.c_eval[i]["t-scores"][j]);
                    }
                    if ($("#p" + i + "_current_level_" + j).length) {
                        $("#p" + i + "_current_level_" + j).html(data.c_eval[i]["levels"][j]);
                    }
                }
                if ($("#p" + i + "_baseline_level_total").length) {
                    $("#p" + i + "_baseline_level_total").html(data.b_eval[i]["average_level"]);
                }
                if ($("#p" + i + "_current_level_total").length) {
                    $("#p" + i + "_current_level_total").html(data.c_eval[i]["average_level"]);
                }
                if ($("#p" + i + "_comment").length) {
                    if (data.is_admin) {
                        $("#p" + i + "_comment").val(data.comments[i]);
                    }
                    else {
                        $("#p" + i + "_comment").html(data.comments[i]);
                    }
                }
                if ($("#p" + i + "_strategy").length) {
                    $("#p" + i + "_strategy").html(data.strategies[i]);
                }
            }
            drawBarChart($("#p0_chart"), ["개방성", "성실성", "외향성", "친화성", "신경성"],
                "Baseline T-Score", "Current T-Score",
                 data.b_eval[0]["t-scores"], data.c_eval[0]["t-scores"],
                 0, 100, null);
            drawBarChart($("#p1_chart"), ["집중력", "자신감", "불안 및 각성", "감정 조절", "생각 조절"],
                "Baseline T-Score", "Current T-Score",
                 data.b_eval[1]["t-scores"], data.c_eval[1]["t-scores"],
                 0, 100, null);
            drawRadarChart($("#p2_chart"), ["자화", "감정조절", "자동성", "목표설정", "심상", "분발/활성화",
                    "부정적 생각", "이완", "컨디션"],
                "Baseline Level", "Current Level",
                data.b_eval[2]["levels"], data.c_eval[2]["levels"]);
            drawBarChart($("#p3_chart"), [["도전", "기술", "균형"], ["활동", "인식", "통합"],
                    ["명확한", "목표"], ["분명한", "피드백"], ["당면", "과제", "집중"], "통제감", ["자의식", "상실"],
                    ["시간의", "변형"], ["자기", "목적적", "경험"]],
                "Baseline Level", "Current Level",
                 data.b_eval[3]["levels"], data.c_eval[3]["levels"],
                 0, 5, 1);
            drawBarChart($("#p4_chart"), ["역경 대처", ["중압감", "에서의", "최상 수행"], ["목표설정", "정신적", "준비"],
                    "집중력", ["걱정", "해방"], ["자신감", "및", "성취동기"], ["지도가능", "상태"]],
                "Baseline Level", "Current Level",
                 data.b_eval[4]["levels"], data.c_eval[4]["levels"],
                 0, 5, 1);
            drawBarChart($("#p5_chart"), ["Basic", "Game plan", ["Decision", "making", "process"],
                    ["Stroke", "saver", "system"], ["Game control", "Strategies"]],
                "Baseline Level", "Current Level",
                 data.b_eval[5]["levels"], data.c_eval[5]["levels"],
                 0, 5, 1);
        }
    });
});
$(function() {
    $(".btn").on("click", function() {
        num = $(this).val();
        comment = $("#p" + num + "_comment").val();
        strategy = $("#p" + num + "_strategy").val();
        $.ajax({
            url: "{% url 'g4_update' %}",
            type: "POST",
            data: {"target_user_id": "{{ target_user_id }}", "idx": num, "comment": comment, "strategy": strategy},
            dataType: "json",
            success: function(data) {
                console.log(data);
            }
        });
    });
});
</script>
{% endblock %}